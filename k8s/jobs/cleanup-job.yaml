# Cleanup Job
# Purpose: Removes old data and temporary files
# Description: Deletes expired sessions, old logs, temp files

apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup
  namespace: default
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cleanup
            image: bharatcart/cleanup:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting cleanup..."
              
              # Delete expired sessions (older than 30 days)
              redis-cli -h redis -a $REDIS_PASSWORD --scan --pattern "session:*" | while read key; do
                TTL=$(redis-cli -h redis -a $REDIS_PASSWORD TTL "$key")
                if [ "$TTL" -eq -1 ]; then
                  redis-cli -h redis -a $REDIS_PASSWORD EXPIRE "$key" 2592000
                fi
              done
              
              # Delete old cart items (older than 90 days)
              psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c "DELETE FROM cart_items WHERE updated_at < NOW() - INTERVAL '90 days';"
              
              # Delete old logs (older than 180 days)
              psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c "DELETE FROM logs WHERE created_at < NOW() - INTERVAL '180 days';"
              
              echo "Cleanup complete"
            env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-secret
                  key: password
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            - name: POSTGRES_DB
              value: "bharatcart"
          restartPolicy: OnFailure
